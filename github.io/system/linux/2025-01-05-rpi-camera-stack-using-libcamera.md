---
layout: single
title: "[linux] libcamera를 사용한 오픈소스 라즈베리파이 카메라 스택"
categories: system/linux
---

#### 주요 내용

- libcamera는 리눅스 개발자가 개발, raspberry pi 팀에서 이를 적극 활용
- libcamera : V4L2를 직접 다루지 않고 추상화된 인터페이스를 제공
- 파이프라인 핸들러 : 드라이버와 제어 알고리즘을 연결하는 주요 역할
- 3A나 드라이버 코드가 오픈 되어 있음
- ISP 드라이버도 V4L2 형태를 띔

## [An open source camera stack for raspberry pi using libcamera](https://www.raspberrypi.com/news/an-open-source-camera-stack-for-raspberry-pi-using-libcamera/) 문서 내용 번역

2013년에 첫 라즈베리 파이 카메라 모듈을 출시한 이래로, 사용자들은 카메라 시스템의 내부(internal)에 더 잘 접근하고, 심지어 자신만의 카메라 센서를 라즈베리 파이 보드에 부착할 수 있도록 해달라고 아우성쳤습니다. 오늘, 우리는 이러한 바람을 현실로 만들어 줄 새로운 오픈 소스 카메라 스택의 첫 번째 버전을 출시합니다.

우리는 다른 센서를 연결하고 이미지 처리에 대한 낮은 수준의 접근을 제공하는 **기반 기술(building blocks)**을 오랫동안 가지고 있었습니다. 하지만 리눅스에는 애플리케이션이 이를 편리하게 활용할 방법이 없었죠. 2018년 말, 리눅스 개발자 그룹이 이 문제를 해결하기 위해 **'리브카메라(libcamera)'**라는 프로젝트를 시작했습니다. 우리는 그때부터 그들과 협력해왔으며, 이제 이 새로운 프레임워크 내에서 작동하는 카메라 스택을 발표하게 되어 기쁩니다."

![libcamera-Diagram](https://www.raspberrypi.org/app/uploads/2020/05/Libcamera-Diagrams-01-500x334.jpg)

**파이프라인 핸들러(Pipeline Handler)**를 제공하여 저희의 드라이버와 제어 알고리즘을 연결하고, libcamera가 예상하는 API에 맞춰 이들을 제시했습니다.
이 작업이 무엇을 수반했는지 좀 더 자세히 설명해 드리겠습니다.

#### V4L2 드라이버

V4L2 (Video for Linux 2)는 이미지와 비디오를 처리하는 장치를 위한 리눅스 커널 드라이버 프레임워크입니다. 이것은 다양한 하드웨어 장치에 비디오 버퍼를 전달하거나, 혹은 전달받는 표준화된 메커니즘을 제공합니다. 전체적인 복잡한 카메라 시스템을 구동하는 수단으로는 다소 다루기 어려움이 입증되었지만, 그럼에도 불구하고 libcamera가 사용해야 할 하드웨어 드라이버의 기반을 제공할 수 있습니다.
결과적으로, 우리는 버전 1 (옴니비전 OV5647)과 버전 2 (소니 IMX219) 카메라 드라이버를 모두 업그레이드하여, 표준 V4L2 방식으로 다양한 모드와 해상도를 지원하도록 만들었습니다. 새로운 라즈베리 파이 고품질 카메라(소니 IMX477 사용)에 대한 지원도 곧 이어질 것입니다. 브로드컴 Unicam 드라이버 역시 V4L2를 기반으로 강화되어, 각 카메라 프레임의 시작을 카메라 스택에 알립니다.
마지막으로, 메모리에 원시 카메라 프레임(Bayer 포맷)을 그대로 저장하는 것은 가치가 제한적입니다. 따라서 V4L2 브로드컴 ISP 드라이버는 원시 이미지를 아름다운 사진으로 바꾸는 데 필요한 모든 제어 기능을 제공합니다.

#### 카메라 제어 알고리즘

브로드컴의 ISP(이미지 신호 처리)를 단순히 설정하는 것만으로는 좋은 사진을 얻기 어렵습니다. 따라서 라즈베리 파이는 자체적으로 ISP 제어 알고리즘을 개발했습니다. 이 알고리즘들은 "3A 알고리즘"으로도 알려져 있습니다.

- AEC/AGC (자동 노출 제어/자동 게인 제어): 이미지 통계를 모니터링하여 카메라 노출을 적절한 수준으로 맞춥니다.
- AWB (자동 화이트 밸런스): 주변 조명을 보정하여 우리 눈에 회색으로 보이는 사물이 최종 이미지에서도 실제로 회색으로 보이도록 합니다.
- 기타 알고리즘: 이 외에도 ALSC(자동 렌즈 음영 보정), 노이즈, 선명도, 대비 등 이미지 처리의 다양한 측면을 제어하는 알고리즘들이 포함되어 있습니다.

이 모든 기술들이 함께 작동하여 카메라가 최적의 이미지를 포착하도록 돕습니다.

![libcamera-isp-flow](https://www.raspberrypi.org/app/uploads/2020/05/Libcamera-Diagrams-02-500x334.jpg)

제어 알고리즘들은 모두 ISP(이미지 신호 프로세서)로부터 통계 정보를 받아, 파이프라인을 통과하는 각 이미지에 대한 메타데이터를 채우는 데 협력합니다. 마지막으로, 이 메타데이터는 이미지 센서와 ISP 모두의 제어 매개변수를 업데이트하는 데 사용됩니다.
이전에는 이러한 기능들이 독점적이고 폐쇄된 소스였으며, 브로드컴(Broadcom) GPU에서 실행되었습니다. 이제는 GPU가 그저 ISP 하드웨어 블록을 통해 픽셀을 넘겨주고 작업이 완료되었음을 알려줄 뿐입니다. 사실상 모든 설정은 ARM 프로세서에서 실행되는 오픈 소스 라즈베리 파이 코드로부터 계산되어 공급됩니다. GPU에는 여전히 쉼 레이어(shim layer)가 존재하여, 라즈베리 파이 자체의 이미지 처리 설정을 브로드컴 SoC의 독점적인 기능으로 변환합니다.
새로운 카메라를 위해 라즈베리 파이의 제어 알고리즘을 올바르게 설정하는 것을 돕기 위해, 우리는 **카메라 튜닝 도구(Camera Tuning Tool)**를 포함했습니다. 혹은 직접 작업하고 싶다면, 제공된 알고리즘을 쉽게 수정하거나 아예 자신만의 것으로 완전히 대체할 수 있습니다.

이 글은 라즈베리 파이의 새로운 오픈 소스 카메라 시스템에 대해 설명하며, 그 배경, 장점, 그리고 미래 방향을 다루고 있습니다.

#### Why libcamera?

ISP(이미지 신호 프로세서) 공급업체들이 때때로 오픈 소스 V4L2 드라이버를 제공하지만, 모든 ISP는 서로 다릅니다. 이 차이점들을 커널 API를 통해 알리는 것은 가능하지만, 이는 휴대용 카메라 애플리케이션을 만들려는 개발자에게 큰 어려움을 줍니다. libcamera는 바로 이 문제를 해결하는 프로젝트입니다. 라즈베리 파이는 libcamera를 통해 누구나 손쉽게 사용할 수 있는 개방적인 개발 플랫폼을 제공하고자 합니다.

#### 새로운 시스템의 의의

라즈베리 파이 팀이 알기로는, 제어 알고리즘(3A)이나 드라이버 코드가 독점적이고 폐쇄적이지 않은 유사한 카메라 시스템은 거의 없습니다. 따라서 자신만의 센서를 사용하거나 알고리즘을 개발하려는 개인에게는 선택지가 거의 없었습니다.
이러한 점에서 새로운 라즈베리 파이 오픈 소스 카메라 시스템은 매우 혁신적인 것을 제공합니다. 접근이 쉽고 비밀스러운 부분이 없기 때문에, 일부 사용자 및 애플리케이션에는 판도를 바꾸는(game-changing) 역할을 할 것으로 예상됩니다.

#### 기존 애플리케이션과의 공존

새로운 오픈 소스 카메라 시스템은 기존 기능을 대체하는 것이 아닙니다. 두 시스템은 당분간 계속 공존할 것입니다. 앞으로 raspistill, raspivid, PiCamera의 libcamera 기반 버전도 추가로 제공될 예정이니 계속해서 소식을 주목해 주세요.

#### 용어 해설 (Glossary)

- 3A 알고리즘: AEC/AGC (자동 노출/게인 제어), AWB (자동 화이트 밸런스), 그리고 AF (자동 초점) 알고리즘을 통칭합니다.
- AEC: 자동 노출 제어.
- AF: 자동 초점.
- AGC: 자동 게인 제어.
- ALSC: 자동 렌즈 음영 보정. 이미지 전체의 색상 변화나 비네팅(테두리 음영)을 보정합니다.
- AWB: 자동 화이트 밸런스.
- Bayer (베이어): 각 픽셀이 하나의 색상(R, G 또는 B)만 갖는 이미지 포맷입니다. 추가적인 처리가 이루어지지 않은 원시(raw) 이미지 포맷입니다.
- CSI-2: 카메라 센서와 라즈베리 파이 사이의 인터페이스 포맷입니다.
- GPU: 그래픽 처리 장치. 여기서는 브로드컴 SoC에 있는 독점적인 멀티미디어 프로세서를 의미합니다.
- ISP: 이미지 신호 프로세서. 원시(Bayer) 이미지를 완전한 색상의 이미지로 변환하는 하드웨어 블록입니다.
- Raw: 베이어 포맷을 참고하세요.
- SoC: 시스템 온 칩. 모든 라즈베리 파이의 핵심 프로세서인 브로드컴 프로세서입니다.
- Unicam: 라즈베리 파이의 브로드컴 SoC에 있는 CSI-2 수신기입니다.
- V4L2: 리눅스용 비디오 2. 비디오 이미지를 처리하는 장치를 위한 리눅스 커널 드라이버 프레임워크입니다.
