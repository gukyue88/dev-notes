---
layout: single
title: "[React] Recoil"
categories: web/react
---

> Recoil 대신 다른 라이브러리를 사용할 것! 현재 React 19 버전 이상을 지원하지 않고, Github 저장소도 적극적으로 개발하거나 유지보수되지 않는 상태로 전환됨.

#### Recoil 이란?

- 전역상태 관리를 도와주는 라이브러리
- 구독 중인 컴포넌트들만 렌더링 시켜 관련 없는 컴포넌트들이 props로 연결되는 걸 막아주고 성능도 높임
  ![redux](https://velog.velcdn.com/images/dongha1992/post/a68dfed6-e6f5-4ca2-aca2-848acac27687/withredux.png)

#### 패키지 설치

```bash
npm install recoil
```

#### RecoilRoot

> Next.js 13 이상에서 Recoil을 사용하기 위해서는 `<RecoilRoot>` 감싸는 클라이언트 컴포넌트인 `<RecoilRootWrapper>`를 만들고, `<RecoilRootWrapper>`를 `RootLayout`에 사용한다.

- 전역상태를 사용하는 컴포넌트들은 `<RecoilRoot>` 의 자식 컴포넌트여야 하는데, `<RecoilRoot>`는 클라이언트 컴포넌트이기 때문에 `"use client"`가 필요함.
- `RootLayout`에 `"use client"`를 써버리게 되면 전체가 서버 컴포넌트를 사용하지 못하게 된다.
- 클라이언트 컴포넌트인 `<RecoilRootWrapper>`를 만들고 이를 `RootLayout`에 사용한다!

components/RecoilRootWrapper.tsx

```tsx
"use client";
import { RecoilRoot } from "recoil";

interface RecoilRootWrapperProps {
  children: React.ReactNode;
}

export default function RecoilRootWrapper({
  children,
}: RecoilRootWrapperProps) {
  return <RecoilRoot>{children}</RecoilRoot>;
}
```

app/layout.tsx

```tsx
import RecoilRootWrapper from "@/components/RecoilWrapper";

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="en">
      <body className={inter.className}>
        <RecoilRootWrapper>{children}</RecoilRootWrapper>
      </body>
    </html>
  );
}
```

#### Recoil 사용

> atom을 추가하고, useState대신 useRecoilState와 같은 훅을 사용함

- atoms를 어디에 보관할 것인가?
  - 프로젝트가 작은 경우 atoms.tsx에 한 번에 모아 관리
  - 프로젝트가 큰 경우, atoms 폴더를 만들고 안에 userAtoms.ts(유저관련 atoms + selectors), themeAtoms.ts(테마관련 atoms + selectors)처럼 나누어 관리

atoms/CountAtoms.ts

```tsx
import { atom } from "recoil";

export const countState = atom<number>({
  key: "countState",
  default: 10,
});
```

Counter component 코드

```tsx
function Counter() {
  const [count, setCount] = useRecoilState(countState);
  useEffect(() => {
    setCount(11);
  }, []);
  return <div>{count}</div>;
}
```

#### Recoil Hooks

- `useRecoilState` : 값과 업데이트 함수를 얻을 때 사용
  - `const [count, setCount] = useRecoilState(countState);`
- `useRecoilValue` : 값만 얻을 때 사용
  - `const count = useRecoilState(countState);`
- `useSetRecoilState` : 업데이트 함수만 얻을 때 사용
  - `const setCount = useRecoilState(countState);`
- `useResetRecoilState` : 값을 default로 리셋하는 함수를 얻을 때 사용
  - `const resetCount = useResetRecoilState(countState);`

#### Selector : 파생된 상태를 만들어 내는 함수, 다른 atom이나 selector로 부터 값을 계산

하나 이상의 `atom`이나 `selector`의 값을 기반으로 새로운 상태를 파생시킬때 사용

- 값을 파생시키는 로직을 컴포넌트 내 직접 구현하지 않고 분리할 수 있음
  - 컴포넌트는 오직 파생된 최종 상태만 받아 렌더링 하는 역할에만 집중
  - 한 곳에서 값을 가공하는 로직을 사용하여 중복 코드 작성 방지
- 재랜더링 방지 : `selector`가 참조하는 값이 변경되도, `selector`가 바뀌지 않으면 해당 컴포넌트가 재랜더링 되지 않음

```tsx
import { selector } from "recoil";

const userNameState = selector({
  key: "userNameState",
  get: ({ get }) => {
    const user = get(userState);
    return user ? user.name : "Guest";
  },
});
```

#### error 발생

```
TypeError: Cannot destructure property 'ReactCurrentDispatcher' of '{imported module [project]/nodemodules/next/dist/compiled/react/index.js [app-client] (ecmascript)}.default.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED' as it is undefined.
```

- recoil이 react19 버전 이상을 지원하지 않아 버전 불일치로 인해 생기는 에러
- recoil이 더이상 활발히 유지보수 되지 않고 있기 때문에, 페이스북에서도 recoil을 사용하지 않는다고 함. 다른 것으로 전환이 필요
