---
layout: single
title: "[supabase] RLS"
categories: web/supabase
---

> RLS : 특정 테이블의 각 행에 대한 접근 규칙을 정의하여, 애플리케이션 코드에서 복잡한 권한 로직없이 보안을 강화할 수 있음.
> RLS를 활성하하면 기본적으로 모든 접근이 거부되고, 명시적으로 접근 허용하는 정책을 생성해줘야함.

- Supabase는 PostgreSQL 데이터 베이스를 사용함.
- RLS는 PostgreSQL에 내장된 보안 기능임.
- RLS는 `Row Level Security`로 **행 레벨 보안**을 의미함.

#### 백엔드 구조

```
클라이언트 <-> 백엔드 서버(API 서버) <-> 데이터베이스
```

- 일반적으로 클라이언트가 데이터베이스를 직접 접근하지 못하도록 중간에 백엔드 서버를 하나 둠.
- supabase를 사용할 경우, supabase가 백엔드 서버의 역할임
- 클라이언트에서 supabase API를 통해 데이터베이스 CRUD를 요청함
- supabase에서 RLS를 확인하고 데이터베이스 요청을 처리함

#### 특화 SQL

> Postgre SQL에서는 RLS를 지원하기 위한 특화된 SQL을 지원함.

- RLS 활성화 : 활성화 이후, 모든 접근 권한이 거부됨

```
ALTER TABLE public.your_table_name ENABLE ROW LEVEL SECURITY;
```

- 정책 생성

```
CREATE POLICY {policy_name}
ON public.your_table_name
FOR {ALL|SELECT|INSERT|UPDATE|DELETE}
TO {public|authenticated}
USING (condition)
WITH CHECK (condition)
```

- `CREATE POLICY {policy_name}` : 정책 생성
- `ON public.your_table_name` : 정책이 적용될 테이블
- `FOR {ALL|SELECT|INSERT|UPDATE|DELETE}` : 정책이 적용될 작업 유형
- `TO {pubilc|authenticated}` : 정책이 적용될 역할
  - pubilc : 모든 사용자
  - authenticated : 로그인한 사용자
  - anon : 비로그인한 사용자
- `USING (condition)` : 어떤 행에 대한 접근을 허용할 것인가?
  - 적용 시점 : 퀴리 실행 이전 (데이터를 필터링할 때)
  - 주요 작업 : `읽기 & 삭제 (SELECT, DELETE)` 작업에 적용
  - 동작 : 조건에 맞지 않는 행은 조회/삭제 되지 않음
- `WITH CHECK (condition)` : 새로 생성되거나 수정된 행의 데이터가 정책을 만족하는가?
  - 적용 시점 : 쿼리 실행 이후 (데이터 삽입/수정시 유효성 검사)
  - 주요 작업 : `쓰기 (INSERT, UPDATE)` 작업에 적용
  - 동작 : 조건에 맞지 않는 삽입/수정 작업은 거부하고 오류 발생
  - update 작업에는 `USING`과 `WITH CHECK`가 함께 사용
    - `USING` : 어떤 기존 행을 업데이트 할 수 있는지 정의
    - `WITH CHECK` : 업데이트 후 결과 행이 정책을 위는하지 않는지 검증
      - 예. 사용자가 자신의 게시물을 업데이트 할 수 있지만, 게시물의 소유자를 다른 사람으로는 바꾸지 못하게 함.
- condition 내용
  - true : 모두 접근 가능
  - false : 모두 접근 불가
  - auth.uid() = user_id 현현재 로그인한 사용자 ID와 행의 user_id가 일치하는 경우)
